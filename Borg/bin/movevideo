#!/usr/bin/env ruby
#
#  Created by Paul McKibbin on 2006-11-05.
#  Updated by Paul McKibbin at 2010-12-27.
#  Copyright (c) 2006-2010. All rights reserved.
LOG_DIR='/var/log/borg'
LOG_FILE='movevideo.log'
COMPLETED_DIR='/vault/tv3/filing'
DESTINATION="/vault/tv3"
require 'rubygems'
require "logger"
require 'fileutils'
$:.unshift(File.join(File.dirname(__FILE__),'..','lib','config'))
require 'Config'
require 'Filename'

class TVMover
  include Config
  config :borg_params

  def initialize(filename)
    Log.info { "Analysing #{filename}." }
    @filename=filename
    @year, @series_name, @season, @episode, @title=Filename::location(filename)
  end

  def actual_directory
    self.class.borg_params[:destinations].each do |directory|
      return File.join(directory,"#{@year}",@series_name) if File.exists?(File.join(directory,"#{@year}"))
    end
    self.class.borg_params[:destinations].each do |directory|
      return File.join(directory,"#{@year}",@series_name) if File.exists?(directory)
    end
  end

  def destination_directory
    @destination_directory||=actual_directory
  end

  def pad_integer(value)
    begin
      "%02d" % value
    rescue
      "00"
    end
  end

  def season
    pad_integer(@season)
  end

  def episode
    pad_integer(@episode)
  end

  def move
    unless @year.nil?
      location=@episode.nil? ? destination_directory : File.join(destination_directory, "Season#{season}")
      move_to(File.join(location, "#{@series_name}_#{season}x#{episode}_#{@title}")) if create_directory(location)
    else
      Log.error{"Unable to determine series details for #{@filename}."}
    end
  end

  def create_directory(series_dirname)
    unless File.exists?(series_dirname)
      Log.debug{"Creating series directory #{series_dirname}."}
      begin
        FileUtils.mkdir_p(series_dirname)
      rescue
        Log.debug{"Failed to create series directory #{series_dirname}."}
        return false
      end
    else
      Log.debug{"Series directory #{series_dirname} already exists."}
    end
    true
  end

  def move_to(destination)
    unless File.exists?(destination)
      Log.info{"Moving #{@filename} to #{destination}."}
      FileUtils.mv(@filename,destination)
    else
      Log.error{"#{destination} already exists. Not moving #{@filename}."}
    end
  end
end


begin
  FileUtils.mkdir_p(LOG_DIR) unless File.exists?(LOG_DIR)
  logfile=File.join(LOG_DIR,LOG_FILE)
  Log=Logger.new(logfile, shift_age='weekly')
rescue => e
  Log=Logger.new(STDOUT)
  Log.error {e.message + ". Logging to stdout."}
end
Log.info {"#{$0} starting."}

if ARGV.empty?
  Log.error {"No files specified. Exiting."}
else
  ARGV.each do |y|
    Dir.glob(y).each do |x|
      filename=x.chomp
      filename=File.join(COMPLETED_DIR,filename) unless File.exists?(filename)
      next if File.directory?(filename)
      if File.exists?(filename) then
        TVMover.new(filename).move
      else
        Log.debug { "Unable to find file #{filename}." }
      end
    end
  end
end
Log.info {"#{$0} completed."}
